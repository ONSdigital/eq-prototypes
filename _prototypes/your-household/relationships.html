---
title: Relationships
project: your-household
globalcss: false
householdMembers:
visitors:
---

<link rel="stylesheet" href="{{ '/css/census-header-footer.css' | prepend: site.baseurl }}"/>
<header class="page__header">
    {% include bar.html %}
    {% include header-census.html %}
</header>

<div class="page__subheader">
    <div class="container">
        <a class="mars" href="../index">Previous</a>
    </div>
</div>

<div class="page__container container">
    <div class="grid grid--reverse">
        <div class="grid__col col-4@m">
            {% include navigation.html items=site.data.your-household.navigationItemsRelationships nav-title-id="section-address" %}
            {% include navigation.html items=page.householdMembers title="Household members" nav-id="navigation-household-members" %}
            {% include navigation.html items=page.visitors title="Visitors" nav-id="navigation-visitors" %}
        </div>
        <div class="grid__col col-7@m pull-1@m">
            <main role="main" id="main" class="page__main">
                <form name="trav" class="form qa-questionnaire-form" role="form" autocomplete="off" novalidate="">
                    <div class="group">
                        <div class="block">
                            <section class="section" id="question-area">
                                <div class="question">
                                    <h1 class="question__title saturn">What is the relationship between
                                        <span class="js-relationship-person-is"></span> and
                                        <span class="js-relationship-person-to"></span>?
                                    </h1>

                                    <p>If members are not related, select the 'unrelated' option, including foster
                                        parents and foster children.</p>

                                    <h2 class="neptune">
                                        <span class="js-relationship-person-is"></span> is
                                        <span class="js-relationship-person-is-relationship-description">...</span> to
                                        <span class="js-relationship-person-to"></span>
                                    </h2>
                                    <div class="answer__fields js-fields">
                                        <div class="field field--radio field--multiplechoice field--cols">
                                            <fieldset>
                                                <div class="field__item js-focusable-box">
                                                    <input class="input input--radio js-focusable"
                                                           type="radio"
                                                           name="relationship"
                                                           id="husband-wife"
                                                           value="husband-wife"/>
                                                    <label class="label label--inline venus"
                                                           for="husband-wife">Husband or wife</label>
                                                </div>
                                                <div class="field__item js-focusable-box">
                                                    <input class="input input--radio js-focusable"
                                                           type="radio"
                                                           name="relationship"
                                                           id="partner"
                                                           value="partner"/>
                                                    <label class="label label--inline venus"
                                                           for="partner">Partner</label>
                                                </div>
                                                <div class="field__item js-focusable-box">
                                                    <input class="input input--radio js-focusable"
                                                           type="radio"
                                                           name="relationship"
                                                           id="mother-father"
                                                           value="mother-father"/>
                                                    <label class="label label--inline venus"
                                                           for="mother-father">Mother or father</label>
                                                </div>
                                                <div class="field__item js-focusable-box">
                                                    <input class="input input--radio js-focusable"
                                                           type="radio"
                                                           name="relationship"
                                                           id="son-daughter"
                                                           value="son-daughter"/>
                                                    <label class="label label--inline venus"
                                                           for="son-daughter">Son or Daughter</label>
                                                </div>
                                                <div class="field__item js-focusable-box">
                                                    <input class="input input--radio js-focusable"
                                                           type="radio"
                                                           name="relationship"
                                                           id="brother-sister"
                                                           value="brother-sister"/>
                                                    <label class="label label--inline venus"
                                                           for="brother-sister">Brother or sister</label>
                                                </div>
                                                <div class="field__item js-focusable-box">
                                                    <input class="input input--radio js-focusable"
                                                           type="radio"
                                                           name="relationship"
                                                           id="other-relation"
                                                           value="other-relation"/>
                                                    <label class="label label--inline venus"
                                                           for="other-relation">Relation - other</label>
                                                </div>
                                                <div class="field__item js-focusable-box">
                                                    <input class="input input--radio js-focusable"
                                                           type="radio"
                                                           name="relationship"
                                                           id="grandparent"
                                                           value="grandparent"/>
                                                    <label class="label label--inline venus"
                                                           for="grandparent">Grandparent</label>
                                                </div>
                                                <div class="field__item js-focusable-box">
                                                    <input class="input input--radio js-focusable"
                                                           type="radio"
                                                           name="relationship"
                                                           id="grandchild"
                                                           value="grandchild"/>
                                                    <label class="label label--inline venus"
                                                           for="grandchild">Grandchild</label>
                                                </div>
                                                <div class="field__item js-focusable-box">
                                                    <input class="input input--radio js-focusable"
                                                           type="radio"
                                                           name="relationship"
                                                           id="unrelated"
                                                           value="unrelated"/>
                                                    <label class="label label--inline venus"
                                                           for="unrelated">Unrelated</label>
                                                </div>
                                            </fieldset>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>
                    <button class="btn btn--primary btn--lg qa-btn-submit venus" type="submit" name="">Save and continue</button>
                </form>
            </main>
        </div>
    </div>
</div>

<script src='/js/compiled/standard-bundle.js'></script>
<script src='/js/compiled/your-household/bundle.js'></script>

<script>
    var storageAPI = window.ONS.storage,
        personIs,
        personTo,
        missingRelationshipFound = true,

        editRelationshipId = new URLSearchParams(window.location.search).get('edit'),
        editRelationshipFound = null;

    function updateQuestion(missingRelationship) {
        personIs = missingRelationship.personIs;
        personTo = missingRelationship.personTo;

        $('.js-relationship-person-is').html(personIs['@person'].fullName);
        $('.js-relationship-person-to').html(personTo['@person'].fullName);
    }

    function findNextMissingRelationship() {
        var householdMembers = window.ONS.storage.getAllHouseholdMembers(),
            relationships = window.ONS.storage.getAllRelationships(),
            missingRelationshipMembers = [],
            personIs = null;

        /**
         * Find the next missing relationship
         */
        $.each(householdMembers, function (i, member) {
            var personId = member['@person'].id;

            /**
             * Get all relationships for this member
             */
            var memberRelationships = relationships.filter(function(relationship) {
                    return relationship.personIsId === personId || relationship.personToId === personId;
                }),

                memberRelationshipToIds = memberRelationships.map(function (relationship) {
                    return relationship.personIsId === personId ? relationship.personToId : relationship.personIsId;
                }) || [];

            /**
             * If total relationships related to this member isn't equal to
             * total household members -1, indicates missing relationship
             */
            if (memberRelationships.length < householdMembers.length - 1) {

                /**
                 * All missing relationship members
                 */
                missingRelationshipMembers = householdMembers.filter(function(m) {
                    return memberRelationshipToIds.indexOf(m['@person'].id) === -1 &&
                        m['@person'].id !== personId;
                });

                personIs = member;

                return false;
            }
        });

        return personIs ? {
            personIs: personIs,
            personTo: missingRelationshipMembers[0]
        } : null;
    }

    function getChosenItem() {
    	var val = $('[name="relationship"]:checked').val();

    	return {
    		val: val,
            description: window.ONS.storage.relationshipDescriptionMap[val]
        };
    }

    /**
     * Edit relationship page setup
     */
	function journeyEditRelationship() {
        editRelationshipFound = storageAPI.getAllRelationships().filter(function (relationship) {
            return relationship.id+'' === editRelationshipId;
        })[0];

        if(editRelationshipFound) {
            updateQuestion({
                personIs: storageAPI.getHouseholdMemberByPersonId(editRelationshipFound.personIsId),
                personTo: storageAPI.getHouseholdMemberByPersonId(editRelationshipFound.personToId)
            });
            $('.qa-btn-submit').on('click', editSubmit_handler.bind(null, editRelationshipId));
        }
        else {
            $('#question-area').html('<h1 class="saturn">Relationship not found</h1>');
        }
    }

    function editSubmit_handler(relationshipId, e) {
        e.preventDefault();

        var chosenItem = getChosenItem(),
            relationshipDescriptionVal = chosenItem.val,
            relationshipDescription = chosenItem.description;

        if(!relationshipDescription) {
            throw Error('Relationship description not found: ', relationshipDescription);
        }

        storageAPI.editRelationship(relationshipId,
            storageAPI.TYPES.relationship(
                relationshipDescriptionVal,
                editRelationshipFound.personIsId,
                editRelationshipFound.personToId,
            )
        );

        window.location.href = '../relationships-summary';
    }

    /**
     * Create relationship page setup
     */
    function journeyCreateNewRelationship() {
		var missingRelationship = findNextMissingRelationship();

        if(missingRelationship) {
            updateQuestion(missingRelationship);
            $('.qa-btn-submit').on('click', missingSubmit_handler);
        }
        else {
            missingRelationshipFound = false;
            $('#question-area').html('<h1 class="saturn">No missing relationships found</h1>');
        }
    }

    function missingSubmit_handler(e) {
        e.preventDefault();

        var nextMissingRelationship,
            chosenItem = getChosenItem(),
            relationshipDescriptionVal = chosenItem.val,
            relationshipDescription = chosenItem.description,
            newRelationship,
            dbRelationshipId;

        if (!missingRelationshipFound) {
            window.location.href = '../relationships-summary';
        }

        if(!relationshipDescription) {
            throw Error('Relationship description not found: ', relationshipDescription);
        }

        newRelationship = window.ONS.storage.addRelationship(
            window.ONS.storage.TYPES.relationship(
                relationshipDescriptionVal,
                personIs['@person'].id,
                personTo['@person'].id
            )
        );

        dbRelationshipId = newRelationship.id;

        nextMissingRelationship = findNextMissingRelationship();

        window.history.replaceState(null, '', '?edit=' + dbRelationshipId);

        /**
         * Routing
         */
        if(nextMissingRelationship) {
            window.location.href = '../relationships';
        }
        else {
            window.location.href = '../relationships-summary';
        }
    }

    $('[name="relationship"]').on('change', function() {
        $('.js-relationship-person-is-relationship-description')
            .html(window.ONS.storage.relationshipDescriptionMap[$(this).val()].sentanceLabel);
    });

    $(function () {

    	/**
         * Code branching - are we trying to edit or create a new relationship
         */
        if(editRelationshipId) {
            journeyEditRelationship();
        }
        else {
            journeyCreateNewRelationship();
        }
    });
</script>
